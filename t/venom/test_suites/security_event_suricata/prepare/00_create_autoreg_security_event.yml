name: Create autoreg security event
testcases:
# Create the fifo
- name: create_the_fifo_file
  steps:
  - type: file_create
    chmod: 0644
    file: "{{.security_event_suricata.fifo_file}}"

- name: create_the_syslog_parser
  steps:
  - type: pf_api_syslog_parsers_create
    id: "Suricata"
    isClone: false
    isNew: true
    syslogParserType: "suricata"
    path: "{{.security_event_suricata.fifo_file}}"
    type: "suricata"

# create the Syslog Parser Suricata
- name: create_security_event
  steps:
  - type: pf_api_security_events_create 
    id: "{{.security_event_suricata.event.id}}"
    access_duration: "{{.security_event_autoreg.event.access_duration}}"
    actions: ["autoreg", "role"]
    desc: "{{.security_event_autoreg.event.desc}}"
    enabled: "Y"
    target_category: "{{.mac_auth.roles.headless_device.id}}"
    triggers: >-
      [{
        "dhcp_fingerprint": "{{.security_event_autoreg.node.dhcp_fingerprint_id}}"
      }]

# restart pfqueue et pf detect
- name: restart_services
  steps:
  - type: pf_api_service_restart
    service: packetfence-pfqueue

  - type: pf_api_service_restart
    service: packetfence-pfdetect

- name: calculate_unregdate_should_be_after
  steps:
  - type: exec
    script: 'date +"%Y-%m-%dT%H:%M:%S+00:00" -d "5 days" > {{.security_event_suricata.unreg_tmp_file}}'

    # Create a fake event
    # echo "Apr 18 10:48:17 pfdetect(6716) INFO: alert received: 04/18/2018-10:48:17.643084 [**] [1:2002878:7] ET POLICY iTunes User Agent [**] [Classification: Potential Corporate Privacy Violation] [Priority: 1] {TCP} {{.node01_mgmt_ip}}:52801 -> 165.254.0.105:80" > /usr/local/pf/var/suricata
  
- name: clear_fingerbank_cache
  steps:
  - type: pfcmd_run_command 
    script: 'cache fingerbank clear'

