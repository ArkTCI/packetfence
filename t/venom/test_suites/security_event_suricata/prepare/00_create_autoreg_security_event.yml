name: Create autoreg security event
testcases:
# Create the fifo
- name: create_the_fifo_file
  steps:
  - type: file_create
    chmod: 0644
    file: "{{.security_event_suricata.fifo_file}}"

- name: create_the_syslog_parser
  steps:
  - type: pf_api_syslog_parsers_create
    id: "{{.security_event_suricata.syslog_parser.id}}"
    isClone: false
    isNew: true
    syslogParserType: "suricata"
    path: "{{.security_event_suricata.fifo_file}}"
    syslog_type: "suricata"

# create the Syslog Parser Suricata
- name: create_security_event
  steps:
  - type: pf_api_security_events_create 
    id: "{{.security_event_suricata.event.id}}"
    access_duration: "{{.security_event_autoreg.event.access_duration}}"
    actions: ["autoreg", "role"]
    desc: "{{.security_event_autoreg.event.desc}}"
    enabled: "Y"
    target_category: "{{.mac_auth.roles.headless_device.id}}"
    triggers: >-
      [{
        "dhcp_fingerprint": "{{.security_event_autoreg.node.dhcp_fingerprint_id}}"
      }]

# restart pfqueue et pf detect
- name: restart_services
  steps:
  - type: pf_api_service_restart
    service: packetfence-pfqueue

  - type: pf_api_service_restart
    service: packetfence-pfdetect

- name: clear_fingerbank_cache
  steps:
  - type: pfcmd_run_command 
    script: 'cache fingerbank clear'
