// to display images directly on GitHub
ifdef::env-github[]
:encoding: UTF-8
:lang: en
:doctype: book
:toc: left
:imagesdir: ../images
endif::[]

////

    This file is part of the PacketFence project.

    See PacketFence_Installation_Guide.asciidoc
    for authors, copyright and license information.

////


== PacketFence Certificates

=== Introduction 

==== Context and Objectives of the Documentation

This documentation aims to provide information and instructions on the implementation, management, and troubleshooting of SSL/TLS certificates for the captive web portal (HTTP) and RADIUS.

The captive portal is a common method of user authentication on a wireless or wired network. It allows controlling user access by redirecting them to an authentication page where they must provide login information. The RADIUS protocol, on the other hand, is used for user authentication and authorization on a network.

==== Definitions and Basic Concepts

Before addressing the implementation, management, and troubleshooting of SSL/TLS certificates, it is important to understand the basic concepts related to security and certificates. The following definitions will be used throughout this documentation:

- SSL/TLS: Secure Sockets Layer/Transport Layer Security, a security protocol that allows encrypting communications between a client and a server.
- SSL/TLS certificate: an electronic file that contains information to verify the identity of a server and establish a secure connection.
- Certificate Authority (CA): an entity that issues and manages SSL/TLS certificates by verifying the identity of the certificate owner.
- Intermediate Certificate: a type of digital certificate that is issued by a trusted root certificate authority and is used to establish a chain of trust between the root certificate and end-entity certificates.
- Private key: an encryption key used to protect confidential information, known only to the certificate owner.
- Public key: an encryption key used to decrypt information encrypted using the private key, known to all users.

By understanding these basic concepts, you will be better tooled to understand and implement SSL/TLS certificates for the captive web portal and RADIUS.

==== Important note before starting

Wildcard certificate is strictly restricted to HTTP, you can't use this type of certificate for RADIUS. 
If you plan to implement certificate for HTTP and RADIUS, we recommand you to use only one certificate to facilitate management of these.

=== Implementation of SSL/TLS Certificate for Captive Web Portal (HTTP)

==== Generate a Certificate Signing Request (CSR)

To implement an SSL/TLS certificate for the captive web portal (HTTP), the first step is to generate a Certificate Signing Request (CSR). The CSR includes information about the organization requesting the certificate, the domain name of the captive portal, and the public key that will be used to encrypt communications.

- Log on the admin web interface (GUI)

- Go to Configuration > System Configuration > SSL Certificates

image::../images/certificate/14-HTTP-CSR.png[scaledwidth="100%",alt="CSR"]

- Click on “Generate Signing Request (CSR)

- Complete the following using your own information, Common Name must match the captive portal hostname in Configuration > General Configuration > Hostname

image::../images/certificate/16-CSR.png[scaledwidth="100%",alt="CSR"]

- Save the CSR and private key to a secure location, you will need it to renew your certificate.

- You can also generate the CSR with CLI using:

[source, shell]
----
openssl req -newkey rsa:2048 -keyout PRIVATEKEY.key -out MYCSR.csr
----

==== Submit the CSR to a Certificate Authority (CA)

Once you have generated the CSR, the next step is to submit it to a Certificate Authority (CA) for validation and issuance of the SSL/TLS certificate. There are many CAs to choose from, and it is important to select a reputable one that is trusted by major web browsers.

To submit the CSR to a CA, follow these steps:

- Select a CA and follow their instructions for submitting a CSR.

- The Subject Alternative Name must exactly match the captive portal hostname in Configuration > General Configuration > Hostname.

- Ensure that your CA supports X509 in base 64 format.

- Provide the CSR and any other required information, such as payment and proof of identity.

- Wait for the CA to validate the CSR and issue the SSL/TLS certificate.

- Download the CA certificate in Apache format.

If your CA provides the certificate in PKCS12 format, you can use the following commands to extract the .crt and .key files:

[source, shell]
----
openssl pkcs12 -in {{.temp_dir}}/{{.input.cn}}.p12 -clcerts -nokeys -out {{.temp_dir}}/{{.input.cn}}.crt -passin pass:secret
openssl pkcs12 -in {{.temp_dir}}/{{.input.cn}}.p12 -nocerts -nodes -out {{.temp_dir}}/{{.input.cn}}.key -passin pass:secret
----

==== Install the SSL/TLS Certificate on the Server

Once you have received the SSL/TLS certificate from the CA, the final step is to install it on PacketFence. This involves configuring the web server to use the SSL/TLS certificate for encrypted communications.

To install the SSL/TLS certificate, follow these steps:

- Open the web admin interface.

- Go to `Configuration > System Configuration > SSL Certificates > HTTP > Edit HTTP Certificates`.

image::../images/certificate/1-HTTP.png[scaledwidth="100%",alt="HTTP"]

- Import or open your certificate file (.crt) with a text editor and copy/paste the content into the "HTTPs Server Certificate" field.

image::certificate/2-HTTP-Certificate.png[scaledwidth="100%",alt="Certificate"]

- Import or open your private key file (.key) and copy/paste the content into the "HTTP Server Private Key" field.

image::certificate/3-HTTP-Private-key.png[scaledwidth="100%",alt="Private key"]

- Turn on the options "Find HTTPs intermediate CA(s) automatically" and "Validate certificate chain".

image::certificate/4-HTTP-intermediate-chain.png[scaledwidth="100%",alt="Intermediate chain"]

- Restart `haproxy-admin` and `haproxy-portal`, one server at a time. You can do this through the web admin page: `Status > Services`.

image::certificate/5-Services.png[scaledwidth="100%",alt="Services"]

Alternatively, you can use the CLI with the following commands:
[source, shell]
----
systemctl restart packetfence-haproxy-admin
systemctl restart packetfence-haproxy-portal
----

By following these steps, you can implement an SSL/TLS certificate for the captive web portal (HTTP) and provide a secure connection for user authentication.

=== Renewal of SSL/TLS Certificate for Captive Portal and Web admin

==== Information about renewal of SSL/TLS Certificate

SSL/TLS certificates have an expiration date, typically ranging from one to three years. To ensure the captive web portal remains secure, it is important to renew the SSL/TLS certificate before it expires. To renew the SSL/TLS certificate, you can use your previous CSR or generate a new one with the exact same information. You will find all the information you need in `System Configuration > SSL Certificate > View HTTP Certificate`.

image::certificate/6-HTTP-View.png[scaledwidth="100%",alt="HTTP--View"]

==== Adding the new certificate

To add the new SSL/TLS certificate, follow these steps:

- Open the PacketFence Web admin interface.

- Go to `System Configuration > SSL Certificate > HTTP > Edit HTTP Certificates`.

- Import the new certificate file (.crt) or paste the content of the new certificate using a text editor into the "HTTPs Server Certificate" field.

image::certificate/2-HTTP-Certificate.png[scaledwidth="100%",alt="Certificate"]

- Turn on the options "Find HTTPs intermediate CA(s) automatically" and "Validate certificate chain".

image::certificate/4-HTTP-intermediate-chain.png[scaledwidth="100%",alt="Intermediate chain"]

- Press "Save" to finish the renewal.

- Restart `haproxy-admin` and `haproxy-portal`, one server at a time. You can do this through the web admin page: Status > Services.

image::certificate/5-Services.png[scaledwidth="100%",alt="Services"]

Alternatively, you can use the CLI with the following commands:
[source, shell]
----
systemctl restart packetfence-haproxy-admin
systemctl restart packetfence-haproxy-portal
----

=== Implementation of SSL/TLS Certificate for RADIUS

==== Generate CSR

If you already have a certificate for your captive portal, you can use the same certificate for RADIUS. In this case, please go directly to section
link:https://www.packetfence.org/docs/PacketFence_Installation_Guide.html#_install_the_ssltls_radius_certificate_on_the_server[36.4.3 Install the SSL/TLS].

Warning: Wildcard certificates will not work with RADIUS. If you are using a wildcard certificate for your captive portal, you will need a new certificate specifically for RADIUS.

To generate a CSR, follow these steps:

- Log on the admin web interface (GUI)

- Go to Configuration > System Configuration > SSL Certificates > RADIUS

image::certificate/15-Radius-CSR.png[scaledwidth="100%",alt="Radius-CSR"]

- Click on “Generate Signing Request (CSR)

- Complete the following using your own information, Common Name must match the captive portal hostname in Configuration > General Configuration > Hostname

image::certificate/17-CSR-radius.png[scaledwidth="100%",alt="CSR"]

- Save the CSR and private key to a secure location, you will need it to renew your certificate.

- You can also generate the CSR with CLI using:
[source, shell]
----
 openssl req -newkey rsa:2048 -keyout PRIVATEKEY.key -out MYCSR.csr
----

==== Submit the CSR to a Certificate Authority (CA)

Please refer to section 
link:https://www.packetfence.org/docs/PacketFence_Installation_Guide.html#_submit_the_csr_to_a_certificate_authority_ca[36.2.2 Submit the CSR to a Certificate Authority (CA)]. and follow the steps mentioned there.

==== Install the SSL/TLS Radius Certificate on the Server

Once you have received the SSL/TLS certificate from the Certificate Authority (CA), the final step is to install it on the RADIUS server. This involves configuring the RADIUS server to use the SSL/TLS certificate for encrypted communications.

To install the SSL/TLS certificate on the RADIUS server, follow these steps:

- Open the web admin interface.

- Go to `Configuration > System Configuration > SSL Certificates > RADIUS > Edit RADIUS Certificates`.

image::certificate/7-Radius-edit.png[scaledwidth="100%",alt="Radius edit"]

- Import or open your certificate file (.crt) with a text editor, then copy and paste the key into the "RADIUS Server Certificate" field.

image::certificate/8-Radius-certificate.png[scaledwidth="100%",alt="Radius certificate"]

- Import or open your private key file (.key) with a text editor, then copy and paste the key into the "RADIUS Server Private Key" field.

image::certificate/9-Radius-key.png[scaledwidth="100%",alt="Radius key"]

- Import or open your certification authority certificate file (.crt) with a text editor, then copy and paste the key into the "RADIUS Server Certification Authority Certificate" field.

image::certificate/10-Radius-CA.png[scaledwidth="100%",alt="Radius CA"]

- Turn on the "Find RADIUS Server intermediate CA(s) automatically" and "Validate certificate chain" option.

image::certificate/13-Radius-intermediate-chain.png[scaledwidth="100%",alt="Radius chain"]

- Restart all `radiusd` services that are running, including `radius-auth`, `radiusd-load-balancer`, `radiusd-acct`, `radiusd-eduroam`, and `radiusd-cli`. Restart them one server at a time. On the web admin page, go to `Status > Services`.

image::certificate/11-Services.png[scaledwidth="100%",alt="Services"]

Alternatively, you can use the following commands in the command-line interface (CLI):

[source, shell]
----
bin/pfcmd service radiusd restart
----

=== Renewal of SSL/TLS Certificate for RADIUS

==== Information about Renewal of SSL/TLS Certificate

To renew the SSL/TLS certificate for RADIUS, you can use your previous Certificate Signing Request (CSR) or generate a new one with the exact same information. You can find all the necessary information in `System Configuration > SSL Certificate > View RADIUS Certificate`. It's important not to use a wildcard certificate for RADIUS.

image::certificate/12-Radius-status.png[scaledwidth="100%",alt="Radius status"]

=== Renewal of SSL/TLS Certificate

To renew the SSL/TLS certificate for RADIUS, follow these steps:

- Open the PacketFence web admin interface `System Configuration > SSL Certificate > RADIUS > Edit RADIUS Certificates`.

- Import the new certificate file (.crt) or paste the content of the new certificate using a text editor into the "RADIUS Server Certificate" field.

image::certificate/8-Radius-certificate.png[scaledwidth="100%",alt="Radius certificate"]

- Add the new Certification Authority certificate.

image::certificate/10-Radius-CA.png[scaledwidth="100%",alt="Radius CA"]

- Turn on the "Find RADIUS Server intermediate CA(s) automatically" and "Validate certificate chain" option.

image::certificate/13-Radius-intermediate-chain.png[scaledwidth="100%",alt="Radius chain"]

- Press "Save" to finish the renewal.

- Restart all `radiusd` services that are running, including `radius-auth`, `radiusd-load-balancer`, `radiusd-acct`, `radiusd-eduroam`, and `radiusd-cli`. Restart them one server at a time. On the web admin page, go to Status > Services.

image::certificate/11-Services.png[scaledwidth="100%",alt="Services"]

Alternatively, you can use the following commands in the command-line interface (CLI):

[source, shell]
----
bin/pfcmd service radiusd restart
----

=== Useful Commands

- Check which configuration files use your certificate:
[source, shell]
----
grep -i "server.crt" -r ./
----

- Check your private key:
[source, shell]
----
(_fd="private.key";\
openssl rsa -check -in ${_fd})
----

=== Glossary

- .pem (Privacy Enhanced Mail): PEM is a base64-encoded certificate or key that is commonly used for transporting certificates over the internet or through email. It is a text file that contains a certificate or a private key in plain text.

- .pfx (Personal Information Exchange): PFX is a binary format used for storing a certificate with its associated private key. It is often used in Microsoft Windows systems and can also contain additional intermediate certificates required to establish a chain of trust.

- .crt (Certificate): CRT is a commonly used file extension for a digital certificate. It contains a public key, along with additional information about the certificate, such as the issuer and expiration date.

- .key (Key): KEY is a file extension used to indicate a private key. Private keys are used to decrypt data that has been encrypted using the corresponding public key in a digital certificate.

